<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>dmrff and CpG site correlation</title>

<script type="text/javascript">
window.onload = function() {
  var imgs = document.getElementsByTagName('img'), i, img;
  for (i = 0; i < imgs.length; i++) {
    img = imgs[i];
    // center an image if it is the only element of its parent
    if (img.parentElement.childElementCount === 1)
      img.parentElement.style.textAlign = 'center';
  }
};
</script>

<!-- Styles for R syntax highlighter -->
<style type="text/css">
   pre .operator,
   pre .paren {
     color: rgb(104, 118, 135)
   }

   pre .literal {
     color: #990073
   }

   pre .number {
     color: #099;
   }

   pre .comment {
     color: #998;
     font-style: italic
   }

   pre .keyword {
     color: #900;
     font-weight: bold
   }

   pre .identifier {
     color: rgb(0, 0, 0);
   }

   pre .string {
     color: #d14;
   }
</style>

<!-- R syntax highlighter -->
<script type="text/javascript">
var hljs=new function(){function m(p){return p.replace(/&/gm,"&amp;").replace(/</gm,"&lt;")}function f(r,q,p){return RegExp(q,"m"+(r.cI?"i":"")+(p?"g":""))}function b(r){for(var p=0;p<r.childNodes.length;p++){var q=r.childNodes[p];if(q.nodeName=="CODE"){return q}if(!(q.nodeType==3&&q.nodeValue.match(/\s+/))){break}}}function h(t,s){var p="";for(var r=0;r<t.childNodes.length;r++){if(t.childNodes[r].nodeType==3){var q=t.childNodes[r].nodeValue;if(s){q=q.replace(/\n/g,"")}p+=q}else{if(t.childNodes[r].nodeName=="BR"){p+="\n"}else{p+=h(t.childNodes[r])}}}if(/MSIE [678]/.test(navigator.userAgent)){p=p.replace(/\r/g,"\n")}return p}function a(s){var r=s.className.split(/\s+/);r=r.concat(s.parentNode.className.split(/\s+/));for(var q=0;q<r.length;q++){var p=r[q].replace(/^language-/,"");if(e[p]){return p}}}function c(q){var p=[];(function(s,t){for(var r=0;r<s.childNodes.length;r++){if(s.childNodes[r].nodeType==3){t+=s.childNodes[r].nodeValue.length}else{if(s.childNodes[r].nodeName=="BR"){t+=1}else{if(s.childNodes[r].nodeType==1){p.push({event:"start",offset:t,node:s.childNodes[r]});t=arguments.callee(s.childNodes[r],t);p.push({event:"stop",offset:t,node:s.childNodes[r]})}}}}return t})(q,0);return p}function k(y,w,x){var q=0;var z="";var s=[];function u(){if(y.length&&w.length){if(y[0].offset!=w[0].offset){return(y[0].offset<w[0].offset)?y:w}else{return w[0].event=="start"?y:w}}else{return y.length?y:w}}function t(D){var A="<"+D.nodeName.toLowerCase();for(var B=0;B<D.attributes.length;B++){var C=D.attributes[B];A+=" "+C.nodeName.toLowerCase();if(C.value!==undefined&&C.value!==false&&C.value!==null){A+='="'+m(C.value)+'"'}}return A+">"}while(y.length||w.length){var v=u().splice(0,1)[0];z+=m(x.substr(q,v.offset-q));q=v.offset;if(v.event=="start"){z+=t(v.node);s.push(v.node)}else{if(v.event=="stop"){var p,r=s.length;do{r--;p=s[r];z+=("</"+p.nodeName.toLowerCase()+">")}while(p!=v.node);s.splice(r,1);while(r<s.length){z+=t(s[r]);r++}}}}return z+m(x.substr(q))}function j(){function q(x,y,v){if(x.compiled){return}var u;var s=[];if(x.k){x.lR=f(y,x.l||hljs.IR,true);for(var w in x.k){if(!x.k.hasOwnProperty(w)){continue}if(x.k[w] instanceof Object){u=x.k[w]}else{u=x.k;w="keyword"}for(var r in u){if(!u.hasOwnProperty(r)){continue}x.k[r]=[w,u[r]];s.push(r)}}}if(!v){if(x.bWK){x.b="\\b("+s.join("|")+")\\s"}x.bR=f(y,x.b?x.b:"\\B|\\b");if(!x.e&&!x.eW){x.e="\\B|\\b"}if(x.e){x.eR=f(y,x.e)}}if(x.i){x.iR=f(y,x.i)}if(x.r===undefined){x.r=1}if(!x.c){x.c=[]}x.compiled=true;for(var t=0;t<x.c.length;t++){if(x.c[t]=="self"){x.c[t]=x}q(x.c[t],y,false)}if(x.starts){q(x.starts,y,false)}}for(var p in e){if(!e.hasOwnProperty(p)){continue}q(e[p].dM,e[p],true)}}function d(B,C){if(!j.called){j();j.called=true}function q(r,M){for(var L=0;L<M.c.length;L++){if((M.c[L].bR.exec(r)||[null])[0]==r){return M.c[L]}}}function v(L,r){if(D[L].e&&D[L].eR.test(r)){return 1}if(D[L].eW){var M=v(L-1,r);return M?M+1:0}return 0}function w(r,L){return L.i&&L.iR.test(r)}function K(N,O){var M=[];for(var L=0;L<N.c.length;L++){M.push(N.c[L].b)}var r=D.length-1;do{if(D[r].e){M.push(D[r].e)}r--}while(D[r+1].eW);if(N.i){M.push(N.i)}return f(O,M.join("|"),true)}function p(M,L){var N=D[D.length-1];if(!N.t){N.t=K(N,E)}N.t.lastIndex=L;var r=N.t.exec(M);return r?[M.substr(L,r.index-L),r[0],false]:[M.substr(L),"",true]}function z(N,r){var L=E.cI?r[0].toLowerCase():r[0];var M=N.k[L];if(M&&M instanceof Array){return M}return false}function F(L,P){L=m(L);if(!P.k){return L}var r="";var O=0;P.lR.lastIndex=0;var M=P.lR.exec(L);while(M){r+=L.substr(O,M.index-O);var N=z(P,M);if(N){x+=N[1];r+='<span class="'+N[0]+'">'+M[0]+"</span>"}else{r+=M[0]}O=P.lR.lastIndex;M=P.lR.exec(L)}return r+L.substr(O,L.length-O)}function J(L,M){if(M.sL&&e[M.sL]){var r=d(M.sL,L);x+=r.keyword_count;return r.value}else{return F(L,M)}}function I(M,r){var L=M.cN?'<span class="'+M.cN+'">':"";if(M.rB){y+=L;M.buffer=""}else{if(M.eB){y+=m(r)+L;M.buffer=""}else{y+=L;M.buffer=r}}D.push(M);A+=M.r}function G(N,M,Q){var R=D[D.length-1];if(Q){y+=J(R.buffer+N,R);return false}var P=q(M,R);if(P){y+=J(R.buffer+N,R);I(P,M);return P.rB}var L=v(D.length-1,M);if(L){var O=R.cN?"</span>":"";if(R.rE){y+=J(R.buffer+N,R)+O}else{if(R.eE){y+=J(R.buffer+N,R)+O+m(M)}else{y+=J(R.buffer+N+M,R)+O}}while(L>1){O=D[D.length-2].cN?"</span>":"";y+=O;L--;D.length--}var r=D[D.length-1];D.length--;D[D.length-1].buffer="";if(r.starts){I(r.starts,"")}return R.rE}if(w(M,R)){throw"Illegal"}}var E=e[B];var D=[E.dM];var A=0;var x=0;var y="";try{var s,u=0;E.dM.buffer="";do{s=p(C,u);var t=G(s[0],s[1],s[2]);u+=s[0].length;if(!t){u+=s[1].length}}while(!s[2]);if(D.length>1){throw"Illegal"}return{r:A,keyword_count:x,value:y}}catch(H){if(H=="Illegal"){return{r:0,keyword_count:0,value:m(C)}}else{throw H}}}function g(t){var p={keyword_count:0,r:0,value:m(t)};var r=p;for(var q in e){if(!e.hasOwnProperty(q)){continue}var s=d(q,t);s.language=q;if(s.keyword_count+s.r>r.keyword_count+r.r){r=s}if(s.keyword_count+s.r>p.keyword_count+p.r){r=p;p=s}}if(r.language){p.second_best=r}return p}function i(r,q,p){if(q){r=r.replace(/^((<[^>]+>|\t)+)/gm,function(t,w,v,u){return w.replace(/\t/g,q)})}if(p){r=r.replace(/\n/g,"<br>")}return r}function n(t,w,r){var x=h(t,r);var v=a(t);var y,s;if(v){y=d(v,x)}else{return}var q=c(t);if(q.length){s=document.createElement("pre");s.innerHTML=y.value;y.value=k(q,c(s),x)}y.value=i(y.value,w,r);var u=t.className;if(!u.match("(\\s|^)(language-)?"+v+"(\\s|$)")){u=u?(u+" "+v):v}if(/MSIE [678]/.test(navigator.userAgent)&&t.tagName=="CODE"&&t.parentNode.tagName=="PRE"){s=t.parentNode;var p=document.createElement("div");p.innerHTML="<pre><code>"+y.value+"</code></pre>";t=p.firstChild.firstChild;p.firstChild.cN=s.cN;s.parentNode.replaceChild(p.firstChild,s)}else{t.innerHTML=y.value}t.className=u;t.result={language:v,kw:y.keyword_count,re:y.r};if(y.second_best){t.second_best={language:y.second_best.language,kw:y.second_best.keyword_count,re:y.second_best.r}}}function o(){if(o.called){return}o.called=true;var r=document.getElementsByTagName("pre");for(var p=0;p<r.length;p++){var q=b(r[p]);if(q){n(q,hljs.tabReplace)}}}function l(){if(window.addEventListener){window.addEventListener("DOMContentLoaded",o,false);window.addEventListener("load",o,false)}else{if(window.attachEvent){window.attachEvent("onload",o)}else{window.onload=o}}}var e={};this.LANGUAGES=e;this.highlight=d;this.highlightAuto=g;this.fixMarkup=i;this.highlightBlock=n;this.initHighlighting=o;this.initHighlightingOnLoad=l;this.IR="[a-zA-Z][a-zA-Z0-9_]*";this.UIR="[a-zA-Z_][a-zA-Z0-9_]*";this.NR="\\b\\d+(\\.\\d+)?";this.CNR="\\b(0[xX][a-fA-F0-9]+|(\\d+(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)";this.BNR="\\b(0b[01]+)";this.RSR="!|!=|!==|%|%=|&|&&|&=|\\*|\\*=|\\+|\\+=|,|\\.|-|-=|/|/=|:|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|\\?|\\[|\\{|\\(|\\^|\\^=|\\||\\|=|\\|\\||~";this.ER="(?![\\s\\S])";this.BE={b:"\\\\.",r:0};this.ASM={cN:"string",b:"'",e:"'",i:"\\n",c:[this.BE],r:0};this.QSM={cN:"string",b:'"',e:'"',i:"\\n",c:[this.BE],r:0};this.CLCM={cN:"comment",b:"//",e:"$"};this.CBLCLM={cN:"comment",b:"/\\*",e:"\\*/"};this.HCM={cN:"comment",b:"#",e:"$"};this.NM={cN:"number",b:this.NR,r:0};this.CNM={cN:"number",b:this.CNR,r:0};this.BNM={cN:"number",b:this.BNR,r:0};this.inherit=function(r,s){var p={};for(var q in r){p[q]=r[q]}if(s){for(var q in s){p[q]=s[q]}}return p}}();hljs.LANGUAGES.cpp=function(){var a={keyword:{"false":1,"int":1,"float":1,"while":1,"private":1,"char":1,"catch":1,"export":1,virtual:1,operator:2,sizeof:2,dynamic_cast:2,typedef:2,const_cast:2,"const":1,struct:1,"for":1,static_cast:2,union:1,namespace:1,unsigned:1,"long":1,"throw":1,"volatile":2,"static":1,"protected":1,bool:1,template:1,mutable:1,"if":1,"public":1,friend:2,"do":1,"return":1,"goto":1,auto:1,"void":2,"enum":1,"else":1,"break":1,"new":1,extern:1,using:1,"true":1,"class":1,asm:1,"case":1,typeid:1,"short":1,reinterpret_cast:2,"default":1,"double":1,register:1,explicit:1,signed:1,typename:1,"try":1,"this":1,"switch":1,"continue":1,wchar_t:1,inline:1,"delete":1,alignof:1,char16_t:1,char32_t:1,constexpr:1,decltype:1,noexcept:1,nullptr:1,static_assert:1,thread_local:1,restrict:1,_Bool:1,complex:1},built_in:{std:1,string:1,cin:1,cout:1,cerr:1,clog:1,stringstream:1,istringstream:1,ostringstream:1,auto_ptr:1,deque:1,list:1,queue:1,stack:1,vector:1,map:1,set:1,bitset:1,multiset:1,multimap:1,unordered_set:1,unordered_map:1,unordered_multiset:1,unordered_multimap:1,array:1,shared_ptr:1}};return{dM:{k:a,i:"</",c:[hljs.CLCM,hljs.CBLCLM,hljs.QSM,{cN:"string",b:"'\\\\?.",e:"'",i:"."},{cN:"number",b:"\\b(\\d+(\\.\\d*)?|\\.\\d+)(u|U|l|L|ul|UL|f|F)"},hljs.CNM,{cN:"preprocessor",b:"#",e:"$"},{cN:"stl_container",b:"\\b(deque|list|queue|stack|vector|map|set|bitset|multiset|multimap|unordered_map|unordered_set|unordered_multiset|unordered_multimap|array)\\s*<",e:">",k:a,r:10,c:["self"]}]}}}();hljs.LANGUAGES.r={dM:{c:[hljs.HCM,{cN:"number",b:"\\b0[xX][0-9a-fA-F]+[Li]?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+(?:[eE][+\\-]?\\d*)?L\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+\\.(?!\\d)(?:i\\b)?",e:hljs.IMMEDIATE_RE,r:1},{cN:"number",b:"\\b\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\.\\d+(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"keyword",b:"(?:tryCatch|library|setGeneric|setGroupGeneric)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\.",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\d+(?![\\w.])",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\b(?:function)",e:hljs.IMMEDIATE_RE,r:2},{cN:"keyword",b:"(?:if|in|break|next|repeat|else|for|return|switch|while|try|stop|warning|require|attach|detach|source|setMethod|setClass)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"literal",b:"(?:NA|NA_integer_|NA_real_|NA_character_|NA_complex_)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"literal",b:"(?:NULL|TRUE|FALSE|T|F|Inf|NaN)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"identifier",b:"[a-zA-Z.][a-zA-Z0-9._]*\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"<\\-(?!\\s*\\d)",e:hljs.IMMEDIATE_RE,r:2},{cN:"operator",b:"\\->|<\\-",e:hljs.IMMEDIATE_RE,r:1},{cN:"operator",b:"%%|~",e:hljs.IMMEDIATE_RE},{cN:"operator",b:">=|<=|==|!=|\\|\\||&&|=|\\+|\\-|\\*|/|\\^|>|<|!|&|\\||\\$|:",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"%",e:"%",i:"\\n",r:1},{cN:"identifier",b:"`",e:"`",r:0},{cN:"string",b:'"',e:'"',c:[hljs.BE],r:0},{cN:"string",b:"'",e:"'",c:[hljs.BE],r:0},{cN:"paren",b:"[[({\\])}]",e:hljs.IMMEDIATE_RE,r:0}]}};
hljs.initHighlightingOnLoad();
</script>



<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 13px;
}

body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 20px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 {
   font-size:2.2em;
}

h2 {
   font-size:1.8em;
}

h3 {
   font-size:1.4em;
}

h4 {
   font-size:1.0em;
}

h5 {
   font-size:0.9em;
}

h6 {
   font-size:0.8em;
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre, img {
  max-width: 100%;
}
pre {
  overflow-x: auto;
}
pre code {
   display: block; padding: 0.5em;
}

code {
  font-size: 92%;
  border: 1px solid #ccc;
  background-color: #E8E8D8;
}

code[class] {
  background-color: #E8E8D8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thick;
   border-top-style: solid;
   border-top-color: #888888;
}

@media print {
   * {
      background: transparent !important;
      color: black !important;
      filter:none !important;
      -ms-filter: none !important;
   }

   body {
      font-size:12pt;
      max-width:100%;
   }

   a, a:visited {
      text-decoration: underline;
   }

   hr {
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote {
      padding-right: 1em;
      page-break-inside: avoid;
   }

   tr, img {
      page-break-inside: avoid;
   }

   img {
      max-width: 100% !important;
   }

   @page :left {
      margin: 15mm 20mm 15mm 10mm;
   }

   @page :right {
      margin: 15mm 10mm 15mm 20mm;
   }

   p, h2, h3 {
      orphans: 3; widows: 3;
   }

   h2, h3 {
      page-break-after: avoid;
   }
}
</style>



</head>

<body>
<div id="toc">
<div id="toc_header">Table of Contents</div>
<ul>
<li>
<a href="#toc_0">dmrff and CpG site correlation</a>
<ul>
<li>
<a href="#toc_1">Generate a dataset with a differentially methylated region of interdependent CpG sites</a>
</li>
<li>
<a href="#toc_2">Perform an EWAS</a>
</li>
<li>
<a href="#toc_3">Apply dmrff</a>
</li>
<li>
<a href="#toc_4">Modify the region to make the CpG sites more independent</a>
</li>
<li>
<a href="#toc_5">Repeat the EWAS and dmrff analyses</a>
</li>
</ul>
</li>
</ul>
</div>


<h2 id="toc_0">dmrff and CpG site correlation</h2>

<p>Here is common question about <code>dmrff</code>:</p>

<blockquote>
<p>My EWAS identifies several regions filled with
CpG sites all weakly associated with my variable of interest.
Why does dmrff identify some but not all of them
as differentially methylated regions?</p>
</blockquote>

<p>The short answer is that the regions that fail the dmrff
test will tend to have CpG sites that are more dependent on one
another, particularly in how they relate to the variable interest.
In other words, the association of a CpG site with the variable
will tend to disappear when one more more other CpG sites are included
in the model.
As a result, the region as a whole will not explain much more variation than is
explained by any individual CpG site.
The regions that pass the dmrff test will tend to
be composed of CpG sites that each explain a somewhat different
proportion of the variability of the variable of interest.
As a result, the region as a whole will explain more variation
than any individual CpG site.</p>

<p>The simulations below illustrates this behavior.</p>

<h3 id="toc_1">Generate a dataset with a differentially methylated region of interdependent CpG sites</h3>

<p>We&#39;ll be generating some random data,
so set the random seed so the output
is reproducible.</p>

<pre><code class="r">set.seed(20200109)
</code></pre>

<p>Start with a completely random DNA methylation dataset.</p>

<pre><code class="r">meth &lt;- t(sapply(1:1000,function(i) runif(100)))
rownames(meth) &lt;- paste(&quot;cg&quot;, 1:nrow(meth), sep=&quot;&quot;)
colnames(meth) &lt;- paste(&quot;s&quot;, 1:ncol(meth), sep=&quot;&quot;)
sites &lt;- data.frame(chr=chr &lt;- rep(&quot;chr1&quot;, nrow(meth)),
                    pos=seq(1,nrow(meth)*50, 50),
                    stringsAsFactors=F)
rownames(sites) &lt;- rownames(meth)
</code></pre>

<p>Insert a differentially methylated region
into the dataset composed of highly correlated CpG sites 
that are weakly correlated with the variable of interest.</p>

<p>The region is composed of 5 CpG sites.</p>

<pre><code class="r">region &lt;- paste(&quot;cg&quot;, 501:505, sep=&quot;&quot;)
region.chr &lt;- sites[region[1],&quot;chr&quot;]
region.start &lt;- min(sites[region,&quot;pos&quot;])
region.end &lt;- max(sites[region,&quot;pos&quot;])
</code></pre>

<p>The following function can be used to generate a variable
of interest and methylation levels for a requested number of CpG sites
with a given correlation structure.</p>

<pre><code class="r">library(MASS)
generate.random.data &lt;- function(var.r, sites.r, n.samples, n.sites) {
    sigma &lt;- sites.r + matrix(rnorm((n.sites+1)^2, sd=0.02), ncol=n.sites+1)
    sigma[1,] &lt;- var.r + rnorm(ncol(sigma), sd=0.02)
    sigma[,1] &lt;- var.r + rnorm(nrow(sigma), sd=0.02)
    diag(sigma) &lt;- 1
    random.vars &lt;- mvrnorm(n=n.samples, mu=rep(0,ncol(sigma)), Sigma=sigma, empirical=TRUE)
    list(var=random.vars[,1],
         meth=t(random.vars[,-1]))
}
</code></pre>

<p>CpG sites will have correlation of about R=0.95 between them
and a correlation of R=0.3 with the variable of interest.</p>

<pre><code class="r">random.data &lt;- generate.random.data(0.3, 0.95, ncol(meth), length(region))
var &lt;- random.data$var
meth[region,] &lt;- random.data$meth
</code></pre>

<p>The correlations between sites are indeed 0.95.</p>

<pre><code class="r">cor(t(meth[region,]))
</code></pre>

<table><thead>
<tr>
<th align="left"></th>
<th align="right">cg501</th>
<th align="right">cg502</th>
<th align="right">cg503</th>
<th align="right">cg504</th>
<th align="right">cg505</th>
</tr>
</thead><tbody>
<tr>
<td align="left">cg501</td>
<td align="right">1.000</td>
<td align="right">0.942</td>
<td align="right">0.979</td>
<td align="right">0.944</td>
<td align="right">0.920</td>
</tr>
<tr>
<td align="left">cg502</td>
<td align="right">0.942</td>
<td align="right">1.000</td>
<td align="right">0.951</td>
<td align="right">0.955</td>
<td align="right">0.944</td>
</tr>
<tr>
<td align="left">cg503</td>
<td align="right">0.979</td>
<td align="right">0.951</td>
<td align="right">1.000</td>
<td align="right">0.953</td>
<td align="right">0.935</td>
</tr>
<tr>
<td align="left">cg504</td>
<td align="right">0.944</td>
<td align="right">0.955</td>
<td align="right">0.953</td>
<td align="right">1.000</td>
<td align="right">0.934</td>
</tr>
<tr>
<td align="left">cg505</td>
<td align="right">0.920</td>
<td align="right">0.944</td>
<td align="right">0.935</td>
<td align="right">0.934</td>
<td align="right">1.000</td>
</tr>
</tbody></table>

<p>The correlations between the sites and the variable of interest are 0.3.</p>

<pre><code class="r">t(sapply(region, function(site) cor(meth[site,],var)))
</code></pre>

<table><thead>
<tr>
<th align="right">cg501</th>
<th align="right">cg502</th>
<th align="right">cg503</th>
<th align="right">cg504</th>
<th align="right">cg505</th>
</tr>
</thead><tbody>
<tr>
<td align="right">0.307</td>
<td align="right">0.311</td>
<td align="right">0.286</td>
<td align="right">0.307</td>
<td align="right">0.318</td>
</tr>
</tbody></table>

<h3 id="toc_2">Perform an EWAS</h3>

<pre><code class="r">stats &lt;- t(sapply(rownames(meth), function(site) coef(summary(lm(meth[site,] ~ var)))[&quot;var&quot;,]))
stats &lt;- as.data.frame(stats)
colnames(stats) &lt;- c(&quot;estimate&quot;,&quot;se&quot;,&quot;t&quot;,&quot;p.value&quot;)
</code></pre>

<p>As expected,
the CpG sites are all similarly associated with the variable of interest.</p>

<pre><code class="r">stats[region,]
</code></pre>

<table><thead>
<tr>
<th align="left"></th>
<th align="right">estimate</th>
<th align="right">se</th>
<th align="right">t</th>
<th align="right">p.value</th>
</tr>
</thead><tbody>
<tr>
<td align="left">cg501</td>
<td align="right">0.3066443</td>
<td align="right">0.0961488</td>
<td align="right">3.189269</td>
<td align="right">0.0019157</td>
</tr>
<tr>
<td align="left">cg502</td>
<td align="right">0.3113416</td>
<td align="right">0.0959946</td>
<td align="right">3.243324</td>
<td align="right">0.0016159</td>
</tr>
<tr>
<td align="left">cg503</td>
<td align="right">0.2862668</td>
<td align="right">0.0967878</td>
<td align="right">2.957676</td>
<td align="right">0.0038849</td>
</tr>
<tr>
<td align="left">cg504</td>
<td align="right">0.3070926</td>
<td align="right">0.0961342</td>
<td align="right">3.194417</td>
<td align="right">0.0018850</td>
</tr>
<tr>
<td align="left">cg505</td>
<td align="right">0.3180351</td>
<td align="right">0.0957704</td>
<td align="right">3.320806</td>
<td align="right">0.0012618</td>
</tr>
</tbody></table>

<h3 id="toc_3">Apply dmrff</h3>

<pre><code class="r">library(dmrff, quietly=T)
dmrs &lt;- dmrff(stats$estimate, stats$se, stats$p.value, meth, sites$chr, sites$pos)
</code></pre>

<pre><code>## [dmrff.candidates] Thu Jan  9 16:55:24 2020 Found  50  candidate regions.
</code></pre>

<p>The following function checks if two regions overlap.
It will be used to identify any regions tested by dmrff
that overlap with the simulated differentially methylated region.</p>

<pre><code class="r">overlaps  &lt;- function(chr1,s1,e1,chr2,s2,e2) {
    chr1 == chr2 &amp; (s1 &gt;= s2 &amp; s1 &lt;= e2
        | e1 &gt;= s2 &amp; e1 &lt;= e2
        | s2 &gt;= s1 &amp; s2 &lt;= e1
        | e2 &gt;= s1 &amp; e2 &lt;= e1)
}
</code></pre>

<p>Notice how the p-value for any region considered is quite similar to
EWAS p-values for the individual CpG sites in the region.
This is because the CpG sites all explain a similar portion
of the variability of the variable of interest.</p>

<pre><code class="r">overlaps.region &lt;- sapply(1:nrow(dmrs), function(i) {
    overlaps(dmrs$chr[i], dmrs$start[i], dmrs$end[i],
             region.chr, region.start, region.end)
})
dmrs[overlaps.region,c(&quot;chr&quot;,&quot;start&quot;,&quot;end&quot;,&quot;n&quot;,&quot;estimate&quot;,&quot;se&quot;,&quot;p.value&quot;,&quot;p.adjust&quot;)]
</code></pre>

<pre><code>##    chr start   end n  estimate         se     p.value p.adjust
## 2 chr1 25001 25201 5 0.3101704 0.09437005 0.001013522        1
</code></pre>

<h3 id="toc_4">Modify the region to make the CpG sites more independent</h3>

<p>Replace the methylation levels of the CpG sites in the region
so that each CpG site is weakly associated with the
variable of interest but mostly independent of one another.</p>

<pre><code class="r">random.data &lt;- generate.random.data(0.3, 0.1, ncol(meth), length(region))
var &lt;- random.data$var
meth[region,] &lt;- random.data$meth
</code></pre>

<p>As before, the correlations between the sites and the variable of interest are roughly 0.3.</p>

<pre><code class="r">t(sapply(region, function(site) cor(meth[site,],var)))
</code></pre>

<table><thead>
<tr>
<th align="right">cg501</th>
<th align="right">cg502</th>
<th align="right">cg503</th>
<th align="right">cg504</th>
<th align="right">cg505</th>
</tr>
</thead><tbody>
<tr>
<td align="right">0.274</td>
<td align="right">0.333</td>
<td align="right">0.312</td>
<td align="right">0.309</td>
<td align="right">0.26</td>
</tr>
</tbody></table>

<p>However, the correlations between the CpG sites are quite low.</p>

<pre><code class="r">cor(t(meth[region,]))
</code></pre>

<table><thead>
<tr>
<th align="left"></th>
<th align="right">cg501</th>
<th align="right">cg502</th>
<th align="right">cg503</th>
<th align="right">cg504</th>
<th align="right">cg505</th>
</tr>
</thead><tbody>
<tr>
<td align="left">cg501</td>
<td align="right">1.000</td>
<td align="right">0.090</td>
<td align="right">0.109</td>
<td align="right">0.102</td>
<td align="right">0.121</td>
</tr>
<tr>
<td align="left">cg502</td>
<td align="right">0.090</td>
<td align="right">1.000</td>
<td align="right">0.094</td>
<td align="right">0.064</td>
<td align="right">0.125</td>
</tr>
<tr>
<td align="left">cg503</td>
<td align="right">0.109</td>
<td align="right">0.094</td>
<td align="right">1.000</td>
<td align="right">0.106</td>
<td align="right">0.125</td>
</tr>
<tr>
<td align="left">cg504</td>
<td align="right">0.102</td>
<td align="right">0.064</td>
<td align="right">0.106</td>
<td align="right">1.000</td>
<td align="right">0.113</td>
</tr>
<tr>
<td align="left">cg505</td>
<td align="right">0.121</td>
<td align="right">0.125</td>
<td align="right">0.125</td>
<td align="right">0.113</td>
<td align="right">1.000</td>
</tr>
</tbody></table>

<h3 id="toc_5">Repeat the EWAS and dmrff analyses</h3>

<p>Repeat the EWAS and DMR analyses with the new dataset.</p>

<pre><code class="r">stats &lt;- t(sapply(rownames(meth), function(site) coef(summary(lm(meth[site,] ~ var)))[&quot;var&quot;,]))
stats &lt;- as.data.frame(stats)
colnames(stats) &lt;- c(&quot;estimate&quot;,&quot;se&quot;,&quot;t&quot;,&quot;p.value&quot;)
dmrs &lt;- dmrff(stats$estimate, stats$se, stats$p.value, meth, sites$chr, sites$pos)
</code></pre>

<pre><code>## [dmrff.candidates] Thu Jan  9 16:55:26 2020 Found  42  candidate regions.
</code></pre>

<p>As before,
the CpG sites are all similarly associated with the variable of interest.</p>

<pre><code class="r">stats[region,]
</code></pre>

<table><thead>
<tr>
<th align="left"></th>
<th align="right">estimate</th>
<th align="right">se</th>
<th align="right">t</th>
<th align="right">p.value</th>
</tr>
</thead><tbody>
<tr>
<td align="left">cg501</td>
<td align="right">0.2742205</td>
<td align="right">0.0971430</td>
<td align="right">2.822854</td>
<td align="right">0.0057649</td>
</tr>
<tr>
<td align="left">cg502</td>
<td align="right">0.3333426</td>
<td align="right">0.0952378</td>
<td align="right">3.500110</td>
<td align="right">0.0007015</td>
</tr>
<tr>
<td align="left">cg503</td>
<td align="right">0.3117340</td>
<td align="right">0.0959816</td>
<td align="right">3.247851</td>
<td align="right">0.0015929</td>
</tr>
<tr>
<td align="left">cg504</td>
<td align="right">0.3092785</td>
<td align="right">0.0960626</td>
<td align="right">3.219551</td>
<td align="right">0.0017419</td>
</tr>
<tr>
<td align="left">cg505</td>
<td align="right">0.2595833</td>
<td align="right">0.0975525</td>
<td align="right">2.660960</td>
<td align="right">0.0091055</td>
</tr>
</tbody></table>

<p>The p-value for the region is much lower than previously.
This is because the CpG sites are independently associated with the
variable of interest so, combined, they explain much more variation than
any single CpG site.</p>

<pre><code class="r">overlaps.region &lt;- sapply(1:nrow(dmrs), function(i) {
    overlaps(dmrs$chr[i], dmrs$start[i], dmrs$end[i],
             region.chr, region.start, region.end)
})
dmrs[overlaps.region,c(&quot;chr&quot;,&quot;start&quot;,&quot;end&quot;,&quot;n&quot;,&quot;estimate&quot;,&quot;se&quot;,&quot;p.value&quot;,&quot;p.adjust&quot;)]
</code></pre>

<pre><code>##    chr start   end n  estimate         se      p.value     p.adjust
## 1 chr1 25001 25201 5 0.2991924 0.05221058 1.001385e-08 1.212677e-05
</code></pre>

</body>

</html>
